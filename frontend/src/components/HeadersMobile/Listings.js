"use client";
import React, { useState } from "react";
import { useRouter } from "next/router";
import { useAuth } from "@/context/AuthContext";
import { searchData } from "@/api/search";
import MobileFilter from "../Filter/MobileFilter";

const MobileSearchBar = () => {
  const [slug, setSlug] = useState("");
  const [isOpen, setIsOpen] = useState(false);

  const { city } = useAuth();
  const router = useRouter();

  const handleSearch = async () => {
    if (!slug?.trim() || !city) return;

    try {
      const res = await searchData(slug, city);

      if (!res || res.status === false || !res.category) {
        console.warn("Invalid search response", res);
        return;
      }

      const categorySlug = res.category.toLowerCase().replace(/\s+/g, "-");
      const citySlug = city.toLowerCase().replace(/\s+/g, "-");

      router.push(`/${categorySlug}/${citySlug}`);
    } catch (error) {
      console.error("Search API failed:", error);
    }
  };

  return (
    <div className=" md:hidden fixed z-50 top-17.5 w-full px-1 pb-1.5 flex  gap-1.5 bg-white">
      <div className="border border-gray-300 shadow-sm  bg-white rounded-md h-10 w-[87%]  flex items-center justify-between px-1.5">
        {/* INPUT */}
        <input
          value={slug}
          onChange={(e) => setSlug(e.target.value)}
          placeholder="What are you looking for?"
          className="text-xs font-semibold text-gray-600 w-full outline-none px-2"
        />

        {/* SEARCH BUTTON */}
        <button onClick={handleSearch} className="ml-2">
          <svg
            width="29"
            height="29"
            viewBox="0 0 29 29"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect width="29" height="29" rx="4" fill="#FF6E04" />
            <path
              d="M21.8424 21.8424L18.3754 18.3692M20.2967 13.7275C20.2967 15.4697 19.6046 17.1406 18.3726 18.3726C17.1406 19.6046 15.4697 20.2967 13.7275 20.2967C11.9852 20.2967 10.3143 19.6046 9.08229 18.3726C7.85032 17.1406 7.1582 15.4697 7.1582 13.7275C7.1582 11.9852 7.85032 10.3143 9.08229 9.08229C10.3143 7.85032 11.9852 7.1582 13.7275 7.1582C15.4697 7.1582 17.1406 7.85032 18.3726 9.08229C19.6046 10.3143 20.2967 11.9852 20.2967 13.7275Z"
              stroke="white"
              strokeWidth="2"
              strokeLinecap="round"
            />
          </svg>
        </button>
      </div>
      <span onClick={() => setIsOpen(true)} className="scale-95">
        <svg
          width="38"
          height="38"
          viewBox="0 0 41 41"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            x="0.5"
            y="0.5"
            width="40"
            height="40"
            rx="5.5"
            fill="white"
            stroke="#A9A9A4"
          />
          <path
            d="M29.4297 28.706C28.9332 28.706 28.4367 28.7124 27.9409 28.7021C27.7743 28.6989 27.6942 28.7476 27.625 28.9084C27.085 30.1576 25.7935 30.8892 24.4373 30.7297C23.1253 30.5753 22.0318 29.5478 21.7877 28.2396C21.5001 26.6957 22.4219 25.1935 23.9421 24.7297C25.4085 24.2825 27.0101 25.0212 27.6225 26.4414C27.6962 26.6125 27.7801 26.6573 27.9556 26.6554C28.9639 26.647 29.9729 26.6464 30.9812 26.6541C31.5053 26.6579 31.9063 27.0218 31.9864 27.5407C32.0588 28.009 31.7795 28.4818 31.3176 28.6342C31.1619 28.6855 30.9883 28.7002 30.823 28.7034C30.3579 28.7118 29.8935 28.706 29.4297 28.706Z"
            fill="#8C8C8C"
          />
          <path
            d="M11.9701 21.5197C11.482 21.5197 10.9932 21.5242 10.505 21.5184C9.88812 21.5108 9.43264 21.0662 9.44097 20.4877C9.44866 19.915 9.89581 19.4826 10.5018 19.4787C11.4948 19.4729 12.4878 19.4729 13.4801 19.4806C13.655 19.4819 13.7421 19.4371 13.8164 19.2654C14.3923 17.9355 15.8305 17.193 17.2411 17.4819C18.6633 17.7727 19.6986 19.0348 19.7056 20.4845C19.712 21.9361 18.703 23.1872 17.2674 23.5069C15.8741 23.8176 14.4154 23.0815 13.8286 21.7555C13.7472 21.5716 13.6556 21.5095 13.4596 21.5152C12.9637 21.5293 12.4666 21.5204 11.9701 21.5197Z"
            fill="#8C8C8C"
          />
          <path
            d="M25.8524 13.3046C25.8678 11.596 27.2387 10.236 28.9332 10.2501C30.6494 10.2642 32.0222 11.6511 31.9998 13.3494C31.9774 15.0445 30.5872 16.4129 28.8998 16.4C27.2086 16.3872 25.837 14.9939 25.8524 13.3046Z"
            fill="#8C8C8C"
          />
          <path
            d="M16.6158 14.3463C14.5832 14.3463 12.5498 14.3482 10.5171 14.345C9.8035 14.3444 9.32303 13.7576 9.47358 13.0856C9.56519 12.6749 9.90599 12.3681 10.3467 12.3059C10.4332 12.2938 10.5223 12.2925 10.61 12.2925C14.6197 12.2918 18.6293 12.2918 22.6389 12.2925C23.195 12.2925 23.5813 12.5359 23.7376 12.9779C23.974 13.6493 23.4897 14.3373 22.7632 14.3444C21.867 14.3527 20.9708 14.3469 20.0739 14.3469C18.9208 14.3463 17.7683 14.3463 16.6158 14.3463Z"
            fill="#8C8C8C"
          />
          <path
            d="M14.5721 28.7071C13.2352 28.7071 11.8982 28.7091 10.5606 28.7065C9.96545 28.7052 9.5529 28.3759 9.46065 27.841C9.35879 27.251 9.79761 26.6949 10.3992 26.6559C10.5189 26.6482 10.6394 26.6527 10.7592 26.6527C13.3691 26.6527 15.9796 26.652 18.5895 26.6533C19.1378 26.6533 19.5517 26.9557 19.6631 27.4317C19.822 28.1088 19.3383 28.7014 18.6074 28.7058C17.5183 28.7129 16.4299 28.7078 15.3409 28.7078C15.0846 28.7071 14.8284 28.7071 14.5721 28.7071Z"
            fill="#8C8C8C"
          />
          <path
            d="M26.8968 19.477C28.2497 19.477 29.6027 19.4713 30.9557 19.4796C31.6546 19.4841 32.1204 20.0786 31.9666 20.7422C31.8686 21.1638 31.4964 21.4822 31.0621 21.5135C30.998 21.518 30.9339 21.5193 30.8699 21.5193C28.2036 21.5193 25.538 21.5199 22.8718 21.5193C22.2728 21.5193 21.8692 21.2137 21.7693 20.6936C21.6501 20.076 22.0889 19.502 22.718 19.4834C23.3183 19.4661 23.9185 19.477 24.5194 19.477C25.3119 19.4764 26.1043 19.477 26.8968 19.477Z"
            fill="#8C8C8C"
          />
        </svg>
      </span>

      {isOpen && <MobileFilter onClose={() => setIsOpen(false)} />}
    </div>
  );
};

export default MobileSearchBar;
