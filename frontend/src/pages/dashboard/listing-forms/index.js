// ========== ListingForms.jsx (COMPLETE WITH SESSION STORAGE) ==========
import {
  add_listings,
  get_payment_mode,
  get_service_facility,
} from "@/api/forms";
import { get_plans } from "@/api/plans";
import BusinessInfo from "@/components/Forms/FormSections/BusinessInfo";
import ContactDetails from "@/components/Forms/FormSections/ContactDetails";
import ImageUploadSections from "@/components/Forms/FormSections/ImageUploadSections";
import SearchEngine from "@/components/Forms/FormSections/SearchEngine";
import SocialDetails from "@/components/Forms/FormSections/SocialDetails";
import Navbar from "@/components/Forms/Navbar";
import Steps from "@/components/Forms/Steps";
import PricingTable from "@/components/Plans/PricingTable";
import Footer from "@/layout/footer";
import { useRouter } from "next/router";
import React, { useEffect, useState, useRef, useCallback } from "react";
import {
  saveToSession,
  getFromSession,
  clearSession,
} from "@/utils/sessionStorage";
import { get_listing_data } from "@/api/showlistings";

const ListingForms = () => {
  const router = useRouter();
  const categoryId = router.query.category;
  const { categoryName, subCategoryName, name } = router.query;
  const category = router.query.categoryName;
  const subCategory = router.query.subCategoryName;

  // Refs for error scrolling
  const businessNameRef = useRef(null);
  const businessAddressRef = useRef(null);
  const businessDescriptionRef = useRef(null);
  const facilitiesRef = useRef(null);
  const servicesRef = useRef(null);
  const websiteLinkRef = useRef(null);
  const videoLinkRef = useRef(null);
  const contactNameRef = useRef(null);
  const contactEmailRef = useRef(null);
  const contactNumberRef = useRef(null);
  const contactAltNumberRef = useRef(null);
  const contactCityRef = useRef(null);
  const contactLandmarkRef = useRef(null);
  const seoTitleRef = useRef(null);
  const seoDescriptionRef = useRef(null);
  const logoRef = useRef(null);
  const imagesRef = useRef(null);
  const planRef = useRef(null);

  const [plans, setPlans] = useState(null);
  const [listingId, setListingId] = useState(null);
  const [selectedFacilities, setSelectedFacilities] = useState([]);
  const [selectedServices, setSelectedServices] = useState([]);
  const [selectedPayment, setSelectedPayment] = useState([]);
  const [selectedPlanId, setSelectedPlanId] = useState(null);
  const [service, setService] = useState([]);
  const [facility, setFacility] = useState([]);
  const [payment, setPayment] = useState([{}]);
  const [existingData, setExistingData] = useState(null);

  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);

  const [business, setBusiness] = useState({
    name: "",
    address: "",
    description: "",
  });

  const [schedule, setSchedule] = useState({
    Monday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
    Tuesday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
    Wednesday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
    Thursday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
    Friday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
    Saturday: { is_open: null, open_time: null, close_time: null },
    Sunday: { is_open: null, open_time: null, close_time: null },
  });

  const [social, setSocial] = useState({
    websiteLink: "",
    videoLink: "",
  });

  const [contact, setContact] = useState({
    name: "",
    email: "",
    number: "",
    altNumber: "",
    city: "",
    landmark: "",
  });

  const [seo, setSeo] = useState({
    title: "",
    description: "",
  });

  const [media, setMedia] = useState({
    logo: null,
    images: [],
  });

  const [steps, setSteps] = useState([
    {
      step: 1,
      title: "Business Information",
      description: "Update your business details & info",
      active: true,
      completed: false,
    },
    {
      step: 2,
      title: "Social Details",
      description: "Add links of your social profiles",
      active: false,
      completed: false,
    },
    {
      step: 3,
      title: "Contact Details",
      description: "Add your contact details for buyers to connect",
      active: false,
      completed: false,
    },
    {
      step: 4,
      title: "Search Engine Friendly",
      description: "Update SEO friendly keywords & description",
      active: false,
      completed: false,
    },
    {
      step: 5,
      title: "Upload Images",
      description: "Upload relevant images of your business",
      active: false,
      completed: false,
    },
    {
      step: 6,
      title: "Payment",
      description: "Proceed for payment",
      active: false,
      completed: false,
    },
  ]);

  // Load data from session storage on mount
  useEffect(() => {
    const savedData = getFromSession();

    if (savedData.business) {
      setBusiness(savedData.business);
    }
    if (savedData.schedule) {
      setSchedule(savedData.schedule);
    }
    if (savedData.social) {
      setSocial(savedData.social);
    }
    if (savedData.contact) {
      setContact(savedData.contact);
    }
    if (savedData.seo) {
      setSeo(savedData.seo);
    }
    if (savedData.selectedFacilities) {
      setSelectedFacilities(savedData.selectedFacilities);
    }
    if (savedData.selectedServices) {
      setSelectedServices(savedData.selectedServices);
    }
    if (savedData.selectedPayment) {
      setSelectedPayment(savedData.selectedPayment);
    }
    if (savedData.selectedPlanId) {
      setSelectedPlanId(savedData.selectedPlanId);
    }
    if (savedData.listingId) {
      setListingId(savedData.listingId);
    }
    if (savedData.currentStep && savedData.currentStep > 1) {
      setActiveStep(savedData.currentStep);
    }
    if (savedData.steps) {
      setSteps(savedData.steps);
    }
  }, []);

  // Save business data to session storage whenever it changes
  useEffect(() => {
    if (business.name || business.address || business.description) {
      saveToSession("business", business);
      setLastSaved(new Date().toLocaleTimeString());
    }
  }, [business]);

  useEffect(() => {
    saveToSession("schedule", schedule);
  }, [schedule]);

  useEffect(() => {
    if (social.websiteLink || social.videoLink) {
      saveToSession("social", social);
      setLastSaved(new Date().toLocaleTimeString());
    }
  }, [social]);

  useEffect(() => {
    if (contact.name || contact.email || contact.number) {
      saveToSession("contact", contact);
      setLastSaved(new Date().toLocaleTimeString());
    }
  }, [contact]);

  useEffect(() => {
    if (seo.title || seo.description) {
      saveToSession("seo", seo);
      setLastSaved(new Date().toLocaleTimeString());
    }
  }, [seo]);

  useEffect(() => {
    if (selectedFacilities.length > 0) {
      saveToSession("selectedFacilities", selectedFacilities);
    }
  }, [selectedFacilities]);

  useEffect(() => {
    if (selectedServices.length > 0) {
      saveToSession("selectedServices", selectedServices);
    }
  }, [selectedServices]);

  useEffect(() => {
    if (selectedPayment.length > 0) {
      saveToSession("selectedPayment", selectedPayment);
    }
  }, [selectedPayment]);

  useEffect(() => {
    if (selectedPlanId) {
      saveToSession("selectedPlanId", selectedPlanId);
    }
  }, [selectedPlanId]);

  useEffect(() => {
    if (listingId) {
      saveToSession("listingId", listingId);
    }
  }, [listingId]);

  // Save steps state
  useEffect(() => {
    saveToSession("steps", steps);
  }, [steps]);

  useEffect(() => {
    // Clear session when user leaves the page (refresh, close, or back)
    const handleBeforeUnload = () => {
      clearSession();
    };

    // Clear session when navigating to another page in Next.js
    const handleRouteChange = () => {
      clearSession();
    };
    // Add event listeners
    window.addEventListener("beforeunload", handleBeforeUnload);
    router.events.on("routeChangeStart", handleRouteChange);
    // Cleanup on unmount
    return () => {
      window.removeEventListener("beforeunload", handleBeforeUnload);
      router.events.off("routeChangeStart", handleRouteChange);
    };
  }, []);

  const getPlans = async () => {
    try {
      const res = await get_plans();
      setPlans(res?.data);
    } catch (error) {
      console.log("error in frontend", error);
    }
  };

  const getListings = useCallback(
    async (name) => {
      try {
        const res = await get_listing_data(name);
        setExistingData(res);
        console.log("response of single listing i am", res);
      } catch (err) {
        console.error("Error fetching listing:", err);
      }
    },
    [name]
  );

  useEffect(() => {
    if (name) {
      getListings(name);
    }
  }, [name, getListings]);

  const formatOpeningHoursForState = (openingHoursArray) => {
    if (!openingHoursArray || !Array.isArray(openingHoursArray)) {
      return {
        Monday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
        Tuesday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
        Wednesday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
        Thursday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
        Friday: { is_open: "1", open_time: "09:00", close_time: "20:00" },
        Saturday: { is_open: null, open_time: null, close_time: null },
        Sunday: { is_open: null, open_time: null, close_time: null },
      };
    }

    const scheduleMap = {};

    openingHoursArray.forEach((hour) => {
      // Convert time from "HH:MM:SS" to "HH:MM"
      const formatTime = (timeString) => {
        if (!timeString) return null;
        return timeString.substring(0, 5); // Extract "HH:MM" from "HH:MM:SS"
      };

      scheduleMap[hour.day] = {
        // Convert is_open from number (0/1) to string ("1"/null)
        is_open: hour.is_open === 1 || hour.is_open === "1" ? "1" : null,
        open_time: hour.is_open === 1 ? formatTime(hour.open_time) : null,
        close_time: hour.is_open === 1 ? formatTime(hour.close_time) : null,
      };
    });

    return scheduleMap;
  };

  useEffect(() => {
    if (existingData && name) {
      // Populate business info
      setBusiness({
        name: existingData?.business_name || "",
        address: existingData?.business_address || "",
        description: existingData?.ad_description || "",
      });

      // Populate schedule from opening_hours - USE THE NEW HELPER FUNCTION
      if (
        existingData?.opening_hours &&
        Array.isArray(existingData.opening_hours)
      ) {
        const formattedSchedule = formatOpeningHoursForState(
          existingData.opening_hours
        );
        setSchedule(formattedSchedule);
      }

      // Populate social links
      setSocial({
        websiteLink: existingData?.website_link || "",
        videoLink: existingData?.video_link || "",
      });

      // Populate contact details
      setContact({
        name: existingData?.name || "",
        email: existingData?.email || "",
        number: existingData?.mobile_number || "",
        altNumber: existingData?.second_mobile_number || "",
        city: existingData?.city || "",
        landmark: existingData?.locality || "",
      });

      // Populate SEO
      setSeo({
        title: existingData?.seo_title || "",
        description: existingData?.seo_description || "",
      });

      // Set listing ID for edit mode
      setListingId(existingData?.id);

      // Populate selected facilities - Use facilities_id for actual IDs
      if (
        existingData?.facilities_id &&
        Array.isArray(existingData.facilities_id)
      ) {
        setSelectedFacilities(existingData.facilities_id);
      }

      // Populate selected services - Use services_id for actual IDs
      if (
        existingData?.services_id &&
        Array.isArray(existingData.services_id)
      ) {
        setSelectedServices(existingData.services_id);
      }

      // Populate selected payment methods - Use payments_id for actual IDs
      if (
        existingData?.payments_id &&
        Array.isArray(existingData.payments_id)
      ) {
        setSelectedPayment(existingData.payments_id);
      }

      // Set existing media
      setMedia({
        logo: existingData?.logo
          ? { preview: existingData.logo, isExisting: true }
          : null,
        images: existingData?.images
          ? existingData.images.map((imgPath, idx) => ({
              preview: imgPath,
              isExisting: true,
              id: idx,
            }))
          : [],
      });
    }
  }, [existingData, name, payment]); // Added 'payment' to dependencies

  useEffect(() => {
    getPlans();
  }, []);

  // Clear specific error
  const clearError = (errorKey) => {
    if (errors[errorKey]) {
      setErrors((prev) => {
        const newErrors = { ...prev };
        delete newErrors[errorKey];
        return newErrors;
      });
    }
  };

  // get service and facilities
  useEffect(() => {
    const getServiceAndFacility = async (categoryId) => {
      const res = await get_service_facility(categoryId);
      if (res?.success === true) {
        const facilities = res?.data?.facilitis || [];
        const services = res?.data?.service || [];
        setFacility(facilities.length > 0 ? facilities : []);
        setService(services.length > 0 ? services : []);
      }
    };
    if (categoryId) {
      getServiceAndFacility(categoryId);
    }
  }, [categoryId]);

  //get payment methods
  useEffect(() => {
    const getPaymentMode = async () => {
      const res = await get_payment_mode();
      setPayment(res);
    };
    getPaymentMode();
  }, []);

  // Scroll to first error field
  const scrollToError = (errorKey) => {
    const errorRefMap = {
      businessName: businessNameRef,
      businessAddress: businessAddressRef,
      businessDescription: businessDescriptionRef,
      facilities: facilitiesRef,
      services: servicesRef,
      websiteLink: websiteLinkRef,
      videoLink: videoLinkRef,
      contactName: contactNameRef,
      contactEmail: contactEmailRef,
      contactNumber: contactNumberRef,
      contactAltNumber: contactAltNumberRef,
      contactCity: contactCityRef,
      contactLandmark: contactLandmarkRef,
      seoTitle: seoTitleRef,
      seoDescription: seoDescriptionRef,
      logo: logoRef,
      images: imagesRef,
      plan: planRef,
    };

    const ref = errorRefMap[errorKey];
    if (ref?.current) {
      ref.current.scrollIntoView({
        behavior: "smooth",
        block: "center",
      });
      if (ref.current.querySelector("input, textarea")) {
        setTimeout(() => {
          ref.current.querySelector("input, textarea")?.focus();
        }, 500);
      }
    }
  };

  const validateStep = (step) => {
    let newErrors = {};
    if (step === 1) {
      if (!business.name.trim()) {
        newErrors.businessName = "Business name is required";
      }
      if (!business.address.trim()) {
        newErrors.businessAddress = "Business address is required";
      }
      if (!business.description.trim()) {
        newErrors.businessDescription = "Description is required";
      }
      if (facility.length > 0 && selectedFacilities.length === 0) {
        newErrors.facilities = "Please select at least one facility";
      }
      if (service.length > 0 && selectedServices.length === 0) {
        newErrors.services = "Please select at least one service";
      }
    }
    if (step === 2) {
      if (!social.websiteLink.trim()) {
        newErrors.websiteLink = "Website link is required";
      }

      if (!social.videoLink.trim()) {
        newErrors.videoLink = "Video link is required";
      }
    }
    if (step === 3) {
      if (!contact.name.trim()) {
        newErrors.contactName = "Contact name is required";
      }
      if (!contact.email.trim()) {
        newErrors.contactEmail = "Email is required";
      }
      if (!contact.number.trim()) {
        newErrors.contactNumber = "Mobile number is required";
      }
      if (contact.altNumber.trim() && !/^[6-9]\d{9}$/.test(contact.altNumber)) {
        newErrors.contactAltNumber = "Enter a valid alternate number";
      }
      if (!contact.city.trim()) {
        newErrors.contactCity = "City is required";
      }
      if (!contact.landmark.trim()) {
        newErrors.contactLandmark = "Landmark is required";
      }
    }
    if (step === 4) {
      if (!seo.title.trim()) {
        newErrors.seoTitle = "SEO title is required";
      } else if (seo.title.length < 10) {
        newErrors.seoTitle = "Title must be at least 10 characters";
      }
      if (!seo.description.trim()) {
        newErrors.seoDescription = "SEO description is required";
      } else if (seo.description.length < 30) {
        newErrors.seoDescription = "Description must be at least 30 characters";
      }
    }
    if (step === 5) {
      if (!media.logo) {
        newErrors.logo = "Logo image is required";
      } else if (media.logo.size > 2 * 1024 * 1024) {
        newErrors.logo = "Logo size must not exceed 2MB";
      }
      if (media.images.length === 0) {
        newErrors.images = "Please upload at least one image";
      } else {
        const oversized = media.images.some(
          (img) => img.size > 2 * 1024 * 1024
        );
        if (oversized) {
          newErrors.images = "Each image must be less than 2MB";
        }
      }
    }
    if (step === 6) {
      if (!selectedPlanId) {
        newErrors.plan = "Please select a plan";
      }
    }
    setErrors(newErrors);
    if (Object.keys(newErrors).length > 0) {
      const firstErrorKey = Object.keys(newErrors)[0];
      setTimeout(() => scrollToError(firstErrorKey), 100);
    }
    return Object.keys(newErrors).length === 0;
  };

  const setActiveStep = (stepNumber) => {
    setSteps((prevSteps) =>
      prevSteps.map((step) => ({
        ...step,
        active: step.step === stepNumber,
        completed: step.step < stepNumber ? true : step.completed,
      }))
    );
    saveToSession("currentStep", stepNumber);
  };

  // Map API error keys to frontend error keys
  const mapApiErrorsToState = (apiErrors, stepNumber) => {
    const errorMapping = {
      1: {
        business_name: "businessName",
        business_address: "businessAddress",
        ad_description: "businessDescription",
        facilities: "facilities",
        services: "services",
        payments: "payments",
        hours: "schedule",
      },
      2: {
        website_link: "websiteLink",
        video_link: "videoLink",
      },
      3: {
        name: "contactName",
        email: "contactEmail",
        mobile_number: "contactNumber",
        second_mobile_number: "contactAltNumber",
        city: "contactCity",
        locality: "contactLandmark",
      },
      4: {
        seo_title: "seoTitle",
        seo_description: "seoDescription",
      },
      5: {
        logo: "logo",
        images: "images",
      },
      6: {
        plan_id: "plan",
      },
    };

    const mappedErrors = {};
    const currentStepMapping = errorMapping[stepNumber] || {};

    Object.keys(apiErrors).forEach((apiKey) => {
      const frontendKey = currentStepMapping[apiKey] || apiKey;
      const errorMessage = Array.isArray(apiErrors[apiKey])
        ? apiErrors[apiKey][0]
        : apiErrors[apiKey];
      mappedErrors[frontendKey] = errorMessage;
    });

    return mappedErrors;
  };

  // Submit data for specific step
  const handleStepSubmit = async (stepNumber) => {
    setIsSubmitting(true);
    setErrors({});
    const formData = new FormData();
    formData.append("category_id", categoryId);
    formData.append("step", stepNumber);
    if (name && existingData?.id) {
      formData.append("listing_id", existingData?.id);
      // formData.append("is_edit", "true");
    } else if (listingId) {
      formData.append("listing_id", listingId);
    }

    switch (stepNumber) {
      case 1:
        formData.append("business_name", business.name);
        formData.append("business_address", business.address);
        formData.append("ad_description", business.description);
        selectedFacilities.forEach((id) => formData.append("facilities[]", id));
        selectedServices.forEach((id) => formData.append("services[]", id));
        selectedPayment.forEach((id) => formData.append("payments[]", id));
        formData.append("hours", JSON.stringify(schedule));
        break;

      case 2:
        formData.append("website_link", social.websiteLink);
        formData.append("video_link", social.videoLink);
        formData.append("listing_id", listingId);
        break;

      case 3:
        formData.append("name", contact.name);
        formData.append("email", contact.email);
        formData.append("mobile_number", contact.number);
        formData.append("listing_id", listingId);
        if (contact.altNumber)
          formData.append("second_mobile_number", contact.altNumber);
        formData.append("city", contact.city);
        formData.append("locality", contact.landmark);
        break;

      case 4:
        formData.append("listing_id", listingId);
        formData.append("seo_title", seo.title);
        formData.append("seo_description", seo.description);
        break;

      case 5:
        formData.append("listing_id", listingId || existingData?.id);
        if (media.logo) {
          if (media.logo.isExisting) {
            formData.append("logo", media.logo.preview);
          } else {
            formData.append("logo", media.logo.file);
          }
        }
        const newImages = media.images.filter((img) => !img.isExisting);
        const existingImages = media.images.filter((img) => img.isExisting);

        newImages.forEach((img) => formData.append("images[]", img.file));
        existingImages.forEach((img) =>
          formData.append("images[]", img.preview)
        );

        break;

      case 6:
        formData.append("listing_id", listingId);
        formData.append("plan_id", selectedPlanId);
        break;

      default:
        break;
    }

    try {
      const response = await add_listings(formData);
      console.log(`Step ${stepNumber} submitted:`, response);

      if (response?.errors && Object.keys(response.errors).length > 0) {
        const mappedErrors = mapApiErrorsToState(response.errors, stepNumber);
        setErrors(mappedErrors);

        const firstErrorKey = Object.keys(mappedErrors)[0];
        setTimeout(() => scrollToError(firstErrorKey), 100);

        setIsSubmitting(false);
        return false;
      }

      // console.log("stepNumber:", stepNumber);
      // console.log("response is this :", response?.data);

      if (stepNumber === 1 && response?.data?.id) {
        setListingId(response?.data?.id);
      }

      if (stepNumber === 6) {
        clearSession();
        console.log("response from 6 ", response);
        if (response?.success) {
          router.push({
            pathname: `/${response?.data?.slug}`,
            query: { preview: true },
          });
        }
        // alert("Listing completed successfully!");
      } else {
        setActiveStep(stepNumber + 1);
      }
      setIsSubmitting(false);
      console.log("main response", response);
      return true;
    } catch (error) {
      console.error(`Error submitting step ${stepNumber}:`, error);
      if (error?.response?.data?.errors) {
        const mappedErrors = mapApiErrorsToState(
          error.response.data.errors,
          stepNumber
        );
        setErrors(mappedErrors);
        const firstErrorKey = Object.keys(mappedErrors)[0];
        setTimeout(() => scrollToError(firstErrorKey), 100);
      } else {
        alert(`Error submitting step ${stepNumber}. Please try again.`);
      }
      setIsSubmitting(false);
      return false;
    }
  };

  const currentStep = steps.find((step) => step.active)?.step || 1;
  const isEditMode = !!name;

  const renderStepContent = () => {
    switch (currentStep) {
      case 1:
        return (
          <BusinessInfo
            category={category}
            subCategory={subCategory}
            selectedPayment={selectedPayment}
            setSelectedPayment={setSelectedPayment}
            selectedFacilities={selectedFacilities}
            selectedServices={selectedServices}
            setSelectedFacilities={setSelectedFacilities}
            setSelectedServices={setSelectedServices}
            business={business}
            setBusiness={setBusiness}
            facilities={facility}
            services={service}
            payment={payment}
            errors={errors}
            schedule={schedule}
            setSchedule={setSchedule}
            clearError={clearError}
            refs={{
              businessNameRef,
              businessAddressRef,
              businessDescriptionRef,
              facilitiesRef,
              servicesRef,
            }}
          />
        );
      case 2:
        return (
          <SocialDetails
            error={errors}
            social={social}
            setSocial={setSocial}
            clearError={clearError}
            refs={{ websiteLinkRef, videoLinkRef }}
          />
        );
      case 3:
        return (
          <ContactDetails
            contact={contact}
            setContact={setContact}
            error={errors}
            clearError={clearError}
            refs={{
              contactNameRef,
              contactEmailRef,
              contactNumberRef,
              contactAltNumberRef,
              contactCityRef,
              contactLandmarkRef,
            }}
          />
        );
      case 4:
        return (
          <SearchEngine
            seo={seo}
            business={business}
            setSeo={setSeo}
            error={errors}
            clearError={clearError}
            refs={{ seoTitleRef, seoDescriptionRef }}
          />
        );
      case 5:
        return (
          <section>
            <ImageUploadSections
              media={media}
              setMedia={setMedia}
              error={errors}
              clearError={clearError}
              refs={{ logoRef, imagesRef }}
              isEditMode={isEditMode}
            />
          </section>
        );
      case 6:
        return (
          <section className="mx-auto w-full" ref={planRef}>
            <div className="p-8 text-center">
              <h2 className="text-2xl font-bold mb-4">Payment Section</h2>
              <PricingTable
                plans={plans}
                selectedPlanId={selectedPlanId}
                setSelectedPlanId={setSelectedPlanId}
                onSelect={() => clearError("plan")}
              />
              {errors.plan && (
                <p className="text-red-500 mt-2">{errors.plan}</p>
              )}
            </div>
          </section>
        );
      default:
        return <BusinessInfo />;
    }
  };

  return (
    <>
      <div className="h-screen w-full">
        <div className="bg-white md:w-[80%] max-md:w-full h-auto mx-auto flex flex-col items-center relative max-w-[2000px]">
          <div className="fixed top-0 md:w-[80%] max-w-[1400px] w-full bg-white z-40">
            <Navbar
              categoryName={categoryName}
              subCategoryName={subCategoryName}
            />
            {/* Auto-save indicator */}
            {/* {lastSaved && (
              <div className="text-xs text-gray-500 flex items-center justify-end gap-1 px-4 py-1">
                <svg
                  className="w-3 h-3 text-green-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fillRule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clipRule="evenodd"
                  />
                </svg>
                Auto-saved at {lastSaved}
              </div>
            )} */}
          </div>

          <section className="mt-26 md:scale-85 max-md:scale-90 2xl:scale-95 flex max-md:mb-5 justify-center">
            <Steps steps={steps} setActiveStep={setActiveStep} />
          </section>

          <div className="flex max-md:flex-col gap-2 2xl:w-[95%] md:mt-14 mb-24">
            <section className="2xl:w-[95%] w-full h-full max-md:px-5 md:pl-10 rounded-xl">
              {renderStepContent()}
            </section>

            <div className="md:w-[420px] mx-2 h-fit shadow-md mt-7 bg-[#FFF8F3] p-3 rounded-xl text-sm">
              <div className="w-full ">
                <h6 className="font-extrabold text-base my-2">Posting Tips</h6>
              </div>
            </div>
          </div>

          <div className="flex justify-between w-[95%] 2xl:w-[95%] mb-8">
            {currentStep > 1 && (
              <button
                onClick={() => setActiveStep(currentStep - 1)}
                disabled={isSubmitting}
                className="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <svg
                  className="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                Previous
              </button>
            )}

            {currentStep === 1 && <div></div>}

            <button
              onClick={async () => {
                if (validateStep(currentStep)) {
                  await handleStepSubmit(currentStep);
                }
              }}
              disabled={isSubmitting}
              className="px-6 py-3 bg-[#FF6E04] hover:bg-[#E55A03] text-white font-semibold rounded-lg transition-colors duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isSubmitting ? (
                <>
                  <svg
                    className="animate-spin h-4 w-4"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      className="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      strokeWidth="4"
                    ></circle>
                    <path
                      className="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  Submitting...
                </>
              ) : (
                <>
                  {currentStep === 6 ? "Complete Payment" : "Next Step"}
                  {currentStep < 6 && (
                    <svg
                      className="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  )}
                </>
              )}
            </button>
          </div>
        </div>
        <section>
          <Footer />
        </section>
      </div>
    </>
  );
};

export default ListingForms;
